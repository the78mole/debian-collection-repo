name: Build APT Repository

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'repos.json'
      - '.github/workflows/build-repo.yml'
      - '.github/scripts/*.sh'

permissions:
  contents: write

jobs:
  build-repository:
    runs-on: ubuntu-latest

    env:
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup directories
        run: |
          # Define supported distributions (Ubuntu + Debian)
          DISTRIBUTIONS="jammy noble bookworm trixie"  # Ubuntu 22.04, 24.04, Debian 12, 13
          ARCHITECTURES="amd64 arm64"
          
          mkdir -p apt-repo/pool/main
          mkdir -p downloads
          
          # Create directory structure for each distribution and architecture
          for dist in $DISTRIBUTIONS; do
            for arch in $ARCHITECTURES; do
              mkdir -p "apt-repo/dists/$dist/main/binary-$arch"
            done
          done

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg jq curl

      - name: Download packages from repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/download-packages.sh repos.json

      - name: Copy packages to pool
        run: |
          if [ -n "$(ls -A downloads/*.deb 2>/dev/null)" ]; then
            cp downloads/*.deb apt-repo/pool/main/
            echo "Copied $(ls downloads/*.deb 2>/dev/null | wc -l) packages"
          else
            echo "No packages found to copy"
            touch apt-repo/dists/stable/main/binary-amd64/Packages
          fi

      - name: Import GPG key
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --yes
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=$KEY_ID" >> $GITHUB_ENV

      - name: Generate APT repository metadata
        run: .github/scripts/generate-metadata.sh apt-repo

      - name: Sign Release file
        if: env.GPG_KEY_ID != ''
        run: .github/scripts/sign-release.sh apt-repo

      - name: Export GPG public key
        if: env.GPG_KEY_ID != ''
        run: |
          gpg --armor --export $GPG_KEY_ID > apt-repo/public.key

      - name: Generate front page
        run: .github/scripts/generate-frontpage.sh apt-repo

      - name: Generate directory indexes
        run: .github/scripts/generate-indexes.sh apt-repo

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

